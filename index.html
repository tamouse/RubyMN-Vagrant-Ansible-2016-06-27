<!DOCTYPE html>
<html>
  <body>
    <p>
      <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title></title>

  <link rel="stylesheet" href="/RubyMN-Vagrant-Ansible-2016-06-27/reveal.js/css/reveal.css">
  <link rel="stylesheet" href="/RubyMN-Vagrant-Ansible-2016-06-27/reveal.js/css/theme/moon.css">

  <!-- Theme used for syntax highlighting of code -->
  <link rel="stylesheet" href="/RubyMN-Vagrant-Ansible-2016-06-27/reveal.js/lib/css/zenburn.css">

  <!-- Printing and PDF exports -->
  <script>
    var link = document.createElement( 'link' );
    link.rel = 'stylesheet';
    link.type = 'text/css';
    link.href = window.location.search.match( /print-pdf/gi ) ? '/RubyMN-Vagrant-Ansible-2016-06-27/reveal.js/css/print/pdf.css' : '/RubyMN-Vagrant-Ansible-2016-06-27/reveal.js/css/print/paper.css';
    document.getElementsByTagName( 'head' )[0].appendChild( link );
  </script>

  <!-- local styles -->
  <link rel="stylesheet" href="/RubyMN-Vagrant-Ansible-2016-06-27/css/slide-styles.css" />
</head>

    </p>
    <div class='reveal'>
      <div class="slides">

<section class=''>
  <h2>Welcome!</h2>
<h3>Using Vagrant & Ansible to Provision New Rails Projects</h3>
<div class='small'>From development out to higher environments, we built a generator to provide us with a single set of tools and configurations that would last the life of the project, and give us a more accurate and controlled means of reaching production.</div>
<img alt='QR Code for Slides' class='qr-code' src='/RubyMN-Vagrant-Ansible-2016-06-27/images/presentation-slides-qr-code.png'>

</section>


<section class=''>
  <h1 id="links">Links</h1>

<ul>
  <li><strong>Slides:</strong> <a href="https://tamouse.github.io/RubyMN-Vagrant-Ansible-2016-06-27/">https://tamouse.github.io/RubyMN-Vagrant-Ansible-2016-06-27/</a></li>
  <li><strong>Slide Repo:</strong> <a href="https://github.com/tamouse/RubyMN-Vagrant-Ansible-2016-06-27">https://github.com/tamouse/RubyMN-Vagrant-Ansible-2016-06-27</a></li>
  <li><strong>Tool Repo:</strong> <a href="https://github.com/ackmann-dickenson/rails_template">https://github.com/ackmann-dickenson/rails_template</a></li>
</ul>

</section>


<section class=''>
  <h2>The Situation</h2>
<ul>
  <li>already using Vagrant extensively</li>
  <li class='fragment'>I had built a Vagrant + Ansible development setup for 2 projects</li>
  <li class='fragment'>starting several new Rails-backed projects</li>
  <li class='fragment'>wanted a modern approach to bootstrapping, provisioning, and deployment</li>
  <li class='fragment'>Ansible is pretty easy to learn</li>
</ul>

</section>


<section class=''>
  <h2>Necessary Parts</h2>
<div class='left-align'>The usual suspects:</div>
<ul>
  <li>VirtualBox</li>
  <li class='fragment'>Vagrant</li>
  <li class='fragment'>Ansible (installed easily on a Mac with HomeBrew)</li>
</ul>

</section>


<section class=''>
  <h2>What is Ansible</h2>
<p>
  <a href='https://www.ansible.com/'>
    Ansible
  </a>
  is really a collection of DevOps tools.
</p>
<ul>
  <li>It lets you bootstrap, provision, and configure hardware (inventory).</li>
  <li class='fragment'>You can using for deploying applications (in place of using capistrano, for example).</li>
  <li class='fragment'>Lots of pre-existing modules, plugins, and an API.</li>
  <li class='fragment'>Highly extensible</li>
</ul>
<div class='fragment'>
  <h4>
    And what separates it from the others:
  </h4>
  <ul>
    <li>Configuration is in simple, plain text files (ini and yaml).</li>
  </ul>
</div>

</section>


<section class=''>
  <h2>Initial Approach</h2>
<ul>
  <li>Our initial approach was to create a shell script, with static elements, that were edited before execution</li>
  <li class='fragment'>This proved unwieldy when going from the first to the second project startup</li>
  <li class='fragment'>It was very useful in prototyping what we wanted</li>
</ul>

</section>


<section class=''>
  <h2>Second Approach: Thor Generator</h2>
<div class='left-align'>Seeing the ridiculousness of our ways and the wisdom in our fumbling, I wrote up a Thor Generator.</div>
<ul>
  <li>Specify destination, i.e. run anywhere</li>
  <li class='fragment'>Site Template: Ansible config, Vagrantfile, provisioning elements</li>
  <li class='fragment'>Rails Template: bring in all standard project gems, configuration settings, initialize the app</li>
  <li class='fragment'>Initialize project specifics, variables, etc.</li>
</ul>

</section>


<section class=''>
  <h2>Creating a new project now consists of 4 semi-automated steps:</h2>
<ol>
  <li>
    run thor script:
    <code>rails_template NAME --dest DEST_DIR</code>
  </li>
  <li class='fragment'>
    in project dir:
    <code>vagrant up --provision</code>
  </li>
  <li class='fragment'>
    in project dir:
    <code>vagrant ssh</code>
  </li>
  <div class='fragment'>
    <li>
      on the VM, in the
      <code><!-- vagrant/ --></code>
      dir:
      <code>rails new . -m rails_template.rb</code>
    </li>
  </div>
</ol>

</section>


<section class=''>
  <h2>Thor Script Actions</h2>
<ul>
  <li>
    populate the new project destination from the
    <code>skeleton/</code>
    directory
  </li>
  <li class='fragment'>run the Ansible requirements installation in the new project destination</li>
</ul>

</section>


<section class=''>
  <h2>Project Skeleton</h2>
<h3>Thor project template</h3>
<pre><code class='nohighlight'>README.md.tt
Vagrantfile.tt
ansible.cfg
provisioning/
rails_template.rb.tt</code></pre>

</section>


<section class=''>
  <h2>Modifying the Vagrantfile</h2>
<div class='left-align'>The following is added to the `dev` configuration section to make Ansible work locally:</div>
<pre><code class='ruby'>dev.vm.provision :ansible do |a|&#x000A;  a.playbook = "provisioning/configure.yml"&#x000A;  a.inventory_path =&#x000A;    "provisioning/inventories/development"&#x000A;  a.verbose = "vvvv"&#x000A;  a.sudo = true&#x000A;end</code></pre>

</section>


<section class=''>
  <h2>Ansible Configuration</h2>
<pre><code class='ini'>[defaults]&#x000A;roles_path = ./provisioning/roles&#x000A;&#x000A;[ssh_connection]&#x000A;ssh_args = -o ForwardAgent=yes \&#x000A;  -o ControlMaster=auto \&#x000A;  -o ControlPersist=60s</code></pre>

</section>


<section class=''>
  <section>
  <h2 id="whats-in-the-provisioning-directory">What's in the <code>provisioning/</code> directory?</h2>
  <pre><code class='nohighlight'>bin/&#x000A;bootstrap.yml&#x000A;configure.yml&#x000A;deploy.yml&#x000A;group_vars/&#x000A;inventories/&#x000A;roles/&#x000A;</code></pre>
</section>
<section>
  <h2 id="bin-directory"><code>bin/</code> directory</h2>
  
  <p>The <code>bin/</code> directory contains shell scripts to make working out to the remove environments simple:</p>
  
  <ul>
    <li><code>bootstrap</code> - set up initial servers environment, sshd, etc</li>
    <li><code>configure</code> - provision the servers</li>
    <li><code>deploy</code> - deploy the application</li>
  </ul>
</section>
<section>
  <h2 id="yaml-playbook-files">YAML Playbook files</h2>
  
  <ul>
    <li><code>bootstrap.yml</code> - steps to perform the initial servers environment setup</li>
    <li><code>configure.yml</code> - the main playbook to run, runs the other playbooks for provisioning the servers</li>
    <li><code>deploy.yml</code> - the deployment playbook</li>
  </ul>
</section>
<section>
  <h2 id="group-variables-groupvars-directory">Group Variables <code>group_vars/</code> directory</h2>
  
  <ul>
    <li>Contains the variable files, in YAML format.</li>
    <li>The files may be plain text, or encrypted (vaults).</li>
    <li>One for each environment.</li>
  </ul>
</section>
<section>
  <h2 id="inventories"><code>inventories/</code></h2>
  
  <ul>
    <li>Inventories are the list of hosts/servers.</li>
    <li>One per environment.</li>
  </ul>
</section>
<section>
  <h2 id="roles"><code>roles/</code></h2>
  
  <ul>
    <li>The roles are the packages to be provisioned.</li>
  </ul>
</section>

</section>


<section class=''>
  <h2 id="the-requirements-role">The requirements role</h2>

<p>The thor script runs the ansible command:</p>

<pre><code class="bash">ansible-galaxy install -r requirements.yml --force</code></pre>

<p>The <code class="highlighter-rouge">-r requirements.yml</code> looks for that file in the <code class="highlighter-rouge">roles_path</code> that was specified in <code class="highlighter-rouge">ansible.cfg</code>.</p>

<p>This loads up the <strong>external</strong> requirements for the project. E.g.:</p>

<pre><code class="yaml">- src: ANXS.postgresql
  version: "v1.2.1"
  path : external</code></pre>

<p>which uses a pre-existing setup for Postgresql</p>

</section>


<section class=''>
  <section>
  <h2>Changing Variables</h2>
  <ul>
    <li class='fragment'>
      The variables for the project are contained under
      <code>provisioning/group_vars/</code>
      directory, named for the environment.
    </li>
    <li class='fragment'>plain text or encyrpted vaults</li>
    <li class='fragment'>vaults can be safely saved in a remote repo</li>
  </ul>
</section>
<section>
  <h2>Standardize most configurable items</h2>
  <ul>
    <li class='fragment'>application name</li>
    <li class='fragment'>database names</li>
    <li class='fragment'>deploy user</li>
    <li class='fragment'>paths to binaries</li>
    <li class='fragment'>development credentials and secrets</li>
  </ul>
</section>
<section>
  <h2>
    Our Convention was embedded
    <br>
    in our Configuration
  </h2>
</section>

</section>


<section class=''>
  <section>
  <h2>Ready for provisioning</h2>
  <div class='fragment'>
    <div class='left-align'>After the thor script has finished, the new project directory has what it needs to start up</div>
    <pre><code class='bash'>vagrant up --provider virtualbox --provision</code></pre>
  </div>
  <div class='fragment'>
    <div class='left-align'>This takes about 10 to 12 minutes.</div>
  </div>
  <div class='fragment'>
    <div class='left-align'>Then you can log in to the VM:</div>
    <pre><code class='bash'>vagrant ssh</code></pre>
  </div>
</section>

</section>


<section class=''>
  <section>
  <h2>Application files location</h2>
  <ul>
    <li class='fragment'>
      The rails application root directory is sitting in
      <code>/vagrant/</code>
    </li>
    <li class='fragment'>
      The provisioning has created a symlink in the
      <code>/home/vagrant/</code>
    </li>
    <li class='fragment'>
      The symlink is the app name
    </li>
  </ul>
</section>
<section>
  <h2>Initialize the Rails App</h2>
  <div class='fragment'>
    <pre><code class='bash'>cd app_name&#x000A;rails new . -m rails_template.rb&#x000A;</code></pre>
  </div>
</section>
<section>
  <h1 class='center-align'>
    YAY!
  </h1>
  <h2 class='fragment'>
    An app is born!
  </h2>
</section>

</section>


<section class=''>
  <section>
  <h2>Changing Provisioning</h2>
  <ul>
    <li class='fragment'>As we went along on the various projects, we found we needed different, additional packages</li>
    <li class='fragment'>We also learned better ways to set up some of the existing packages and configurations</li>
  </ul>
</section>
<section>
  <h2>Additional Playbooks</h2>
  <div class='left-align'>We added new playbooks as we discovered new needs</div>
  <ul>
    <li class='fragment'>Internal</li>
    <li class='fragment'>External</li>
  </ul>
</section>
<section>
  <h2>Easy re-provisioning</h2>
  <pre><code class='bash'>vagrant provision</code></pre>
</section>
<section>
  <h3>This saved us tons of time</h3>
  <h3 class='fragment'>and kept our downstream provisioning and deployments clean as well</h3>
</section>

</section>


<section class=''>
  <section>
  <h2>Staging, and Further Deployments</h2>
  <ul>
    <li class='fragment'>
      Update the appropriate inventory file under
      <code>provisioning/inventories/staging</code>
    </li>
    <li class='fragment'>
      Update the environment variables in the file under
      <code>provisioning/group_vars/staging</code>
    </li>
  </ul>
</section>
<section>
  <h3>Inventory File</h3>
  <div class='left-align'>
    This is an
    <code>ini</code>
    file, and contains the IP addresses of the staging host(s)
  </div>
  <pre><code class='ini'>[webservers]&#x000A;101.xxx.xxx.xxx&#x000A;&#x000A;[databases]&#x000A;101.xxx.xxx.xxx&#x000A;&#x000A;[staging:children]&#x000A;webservers&#x000A;databases&#x000A;</code></pre>
</section>
<section>
  <h3>Operating Environment Variables</h3>
  <ul>
    <li class='fragment'>
      This is a YAML file specifying the settings to use in this environment.
    </li>
    <li class='fragment'>
      For higher environments, these files are encrypted
    </li>
    <li class='fragment'>
      Manipulate with the
      <code>ansible-vault</code>
      command.
    </li>
    <li class='fragment'>
      <pre><code class='bash'>ansible-vault edit provisioning/group_vars/staging</code></pre>
    </li>
    <li class='fragment'>
      Prompts for the password, then opens in
      <code>$EDITOR</code>
    </li>
  </ul>
</section>
<section>
  <h2>Provisioning Scripts</h2>
  <div class='left-align'>
    In the
    <code>provisioning/bin/</code>
    folder are scripts that run the Ansible commands to
    <strong>bootstrap, configure, and deploy</strong>
    the application to the appropriate environment, which makes it really simple:
  </div>
  <pre><code class='bash'>provisioning/bin/deploy staging</code></pre>
</section>
<section>
  <div class='left-align'>Which contains:</div>
  <pre><code class='bash'>if [ -z "$1" ]; then&#x000A;  echo "Please specify an inventory/environment"&#x000A;  exit 1&#x000A;fi&#x000A;inventory=$1&#x000A;&#x000A;ansible-playbook \&#x000A;  --inventory-file=provisioning/inventories/$inventory \&#x000A;  --user deploy --ask-vault-pass \&#x000A;  --extra-vars '{"app_name":"xxx"}' -vvvv \&#x000A;  provisioning/deploy.yml&#x000A;</code></pre>
</section>
<section>
  <h3>
    The meat is in
    <code>provisioning/deploy.yml</code>
  </h3>
  <pre class='fragment tiny'><code class='yaml'>---&#x000A;- hosts: webservers&#x000A;&#x000A;  roles:&#x000A;    - internal/deploy&#x000A;&#x000A;  tasks:&#x000A;    - set_fact: this_release_ts={{ lookup('pipe', 'date +%Y%m%d%H%M%S') }}&#x000A;    - set_fact: this_release_path={{ releases_path }}/{{ this_release_ts }}&#x000A;&#x000A;    - stat: path={{ current_release_path }}&#x000A;      register: current_dir&#x000A;&#x000A;    - debug: msg="New release path {{ this_release_path }}"&#x000A;&#x000A;    - debug: msg="current_dir exists? {{ current_dir.stat.exists }}"&#x000A;&#x000A;    - name: display maintenance page&#x000A;      copy:&#x000A;        src: roles/internal/deploy/files/maintenance.html&#x000A;        dest: "{{ current_release_path }}/maintenance.html"&#x000A;        force: yes&#x000A;      when: current_dir.stat.exists == True&#x000A;&#x000A;    - name: stop sidekiq&#x000A;      sudo: true&#x000A;      service: name=sidekiq-workers state=stopped&#x000A;      when: current_dir.stat.exists == True&#x000A;&#x000A;    - name: stop puma&#x000A;      sudo: true&#x000A;      service: name=puma state=stopped args="app={{ current_release_path }}"&#x000A;      when: current_dir.stat.exists == True&#x000A;&#x000A;    - name: create new release dir&#x000A;      file: path={{ this_release_path }} state=directory&#x000A;&#x000A;    - name: update code&#x000A;      git: repo={{ git_url }} dest={{ this_release_path }} version={{ git_version }} accept_hostkey=yes&#x000A;      register: git&#x000A;&#x000A;    - debug: msg='Updated repo from {{ git.before }} to {{ git.after }}'&#x000A;&#x000A;    - name: create shared dir&#x000A;      file: path={{ shared_path }} state=directory&#x000A;&#x000A;    - name: create shared sub-dirs&#x000A;      file: path={{ shared_path }}/{{ item }} state=directory&#x000A;      with_items:&#x000A;        - log&#x000A;        - tmp&#x000A;        - tmp/puma&#x000A;&#x000A;    - name: create config files&#x000A;      template:&#x000A;        src: "roles/internal/deploy/templates/{{ item }}.j2"&#x000A;        dest: "{{ this_release_path }}/{{ item }}"&#x000A;        force: yes&#x000A;      with_items:&#x000A;        - config/database.yml&#x000A;        - config/secrets.yml&#x000A;        - config/puma.rb&#x000A;&#x000A;    - name: symlink shared files&#x000A;      file:&#x000A;        src: "{{ shared_path }}/{{ item }}"&#x000A;        dest: "{{ this_release_path }}/{{ item }}"&#x000A;        state: link&#x000A;        force: yes&#x000A;      with_items:&#x000A;        - log/{{ rails_env }}.log&#x000A;        - log/sidekiq.log&#x000A;&#x000A;    - name: install gems&#x000A;      command: '{{ ruby_path }}/bin/bundle install --deployment --without="development test"'&#x000A;      args:&#x000A;        chdir: '{{ this_release_path }}'&#x000A;&#x000A;    - name: precompile assets&#x000A;      command: "{{ ruby_path }}/bin/rake assets:precompile chdir={{ this_release_path }}"&#x000A;      environment:&#x000A;        RAILS_ENV: '{{ rails_env }}'&#x000A;&#x000A;    - name: migrate database&#x000A;      command: "{{ ruby_path }}/bin/rake db:migrate chdir={{ this_release_path }}"&#x000A;      environment:&#x000A;        RAILS_ENV: '{{ rails_env }}'&#x000A;&#x000A;    - name: remove maintenance page&#x000A;      file: path={{ current_release_path }}/maintenance.html state=absent force=true&#x000A;&#x000A;    - name: symlink new release&#x000A;      file: src={{ this_release_path }} dest={{ current_release_path }} state=link force=yes&#x000A;&#x000A;    - name: start puma&#x000A;      sudo: true&#x000A;      service: name=puma state=started args="app={{ current_release_path }}"&#x000A;&#x000A;    - name: start sidekiq&#x000A;      sudo: true&#x000A;      service: name=sidekiq-workers state=started&#x000A;&#x000A;    - name: cleanup&#x000A;      shell: "ls -1t {{ releases_path }}|tail -n +{{ keep_releases + 1 }}|xargs rm -rf"&#x000A;      args:&#x000A;        chdir: '{{ releases_path }}'</code></pre>
</section>

</section>


<section class=''>
  <section>

  <h3 id="some-of-the-external-packages-we-used">Some of the External Packages We Used</h3>

  <ul>
    <li>ANXS.postgresql</li>
    <li>DavidWittman.redis</li>
    <li>geerlingguy.nodejs</li>
    <li>jdauphant.nginx</li>
  </ul>

  <p>These are publicly available.</p>

</section>

<section>

  <h3 id="ad-had-some-of-their-own">A&amp;D had some of their own:</h3>

  <ul>
    <li>common stuff – things like <code class="highlighter-rouge">build-essential</code>, <code class="highlighter-rouge">vim</code>, <code class="highlighter-rouge">emacs24</code>, etc</li>
    <li>ruby – setting up <code class="highlighter-rouge">ruby-install</code>, installing the chosen version</li>
  </ul>

  <p>These are not publicly available, but they are dead simple.</p>

</section>

<section>

  <h3 id="example-common-stuff">Example: common stuff</h3>

  <pre><code class="yaml">---
- name: update apt sources
  sudo: yes
  apt: update_cache=yes

- name: install essential software via apt
  sudo: true
  apt: name={{ item.package }}
  with_items:
    - package: build-essential
    - package: ntp
    - package: git
    - package: vim
    - package: emacs24</code></pre>

</section>

<section>

  <h3 id="example-ruby-install">Example: ruby-install</h3>

  <pre><code class="yaml">---
- name: update apt sources
  sudo: yes
  apt: update_cache=yes

- name: install dependencies
  sudo: true
  apt: name={{ item.package }}
  with_items:
    - package: nodejs
    - package: libyaml-dev
    - package: libxml2-dev
    - package: libxslt-dev

- name: create source directory
  sudo: true
  shell: mkdir -p /usr/local/src creates=/usr/local/src

- name: clone ruby-install
  sudo: true
  git: repo=https://github.com/postmodern/ruby-install.git dest=/usr/local/src/ruby-install update=yes

- name: install ruby-install
  sudo: true
  command: make install chdir=/usr/local/src/ruby-install creates=/usr/local/bin/ruby-install

- name: install rubies
  sudo: true
  command: /usr/local/bin/ruby-install ruby {{ ruby_version }} creates={{ ruby_path }}

- name: install bundler
  sudo: true
  command: /opt/rubies/ruby-{{ ruby_version }}/bin/gem install bundler --no-user-install --no-document
</code></pre>

</section>

</section>


<section class=''>
  <section>
  <h3>Acknowledgements</h3>
  <blockquote>
    I want to acknowlege the great folks at
    <a href='http://ackmann-dickenson.com'>Ackmann & Dickenson,</a>
    <br>
    especially
    <b>Jason Bucki</b>
    and
    <b>Will Watson,</b>
    for their great encouragement
    <br>
    and for opening up the tool to public access.
  </blockquote>
</section>
<section>
  <h3>Contact info</h3>
  <ul>
    <li>Tamara Temple</li>
    <li>Email: <a href="&#109;&#097;&#105;&#108;&#116;&#111;:&#116;&#097;&#109;&#111;&#117;&#115;&#101;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;">&#116;&#097;&#109;&#111;&#117;&#115;&#101;&#064;&#103;&#109;&#097;&#105;&#108;&#046;&#099;&#111;&#109;</a></li>
    <li>Github: <a href="https://github.com/tamouse">tamouse</a></li>
    <li>Twitter: <a href="https://twitter.com/tamouse">@tamouse</a></li>
    <li>WWW: <a href="http://www.tamouse.org">http://www.tamouse.org</a></li>
  </ul>
</section>

</section>


<footer class="slide-footer">
  <div class="left">Vagrant+Ansible for Rails</div>
  <div class="middle">
    <a href="http://www.tamouse.org"
       target="_blank"
       title="Tamara Temple"
       >
      Tamara Temple
    </a>
  </div>
  <div class="right">
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/80x15.png" /></a>

  </div>
</footer>

</div><!-- .slides -->

    </div>
    <!-- .reveal -->
    <script src="/RubyMN-Vagrant-Ansible-2016-06-27/reveal.js/lib/js/head.min.js"></script>
<script src="/RubyMN-Vagrant-Ansible-2016-06-27/reveal.js/js/reveal.js"></script>
<script src="/RubyMN-Vagrant-Ansible-2016-06-27/js/revealConfig.js"></script>

  </body>
</html>
